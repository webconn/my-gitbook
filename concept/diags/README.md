# Диагностики

**Диагностика** - это что-то вроде контрольной лампы на приборной панели. С помощью диагностик можно быстро определить, всё ли хорошо в системе в целом или в отдельных компонентах.

Для того, чтобы не заставлять пользователя смотреть каждую диагностику отдельно \(а их может быть очень много\), в системе будет работать агрегатор диагностик, который будет формировать сводку по статусам отдельных категорий. Таким образом, у пользователя будет возможность посмотреть общий статус системы `wb-mqtt-serial` или, например, статус отдельной шины.

### Как это может работать

Реализовать сбор диагностик можно через MQTT - в этом случае диагностики представляют собой топики по пути `/diags/path/to/diag`, где путь формируется аналогично категориям в логах \(см. [Логи 2.0](../logs_2_0.md)\);

Cервис, публикующий диагностические сообщения, периодически \(с достаточно большим периодом, чтобы не забивать брокер и логи, порядка раза в секунду\) отправляет сообщения следующего формата \(в формате JSON или отдельными сообщениями по пути\):

```text
{
  "id": "[uuid]",        // ID диагностики, чтобы различать их в логах
  "launch_id": "[uuid]", // ID запуска демона, чтобы определять актуальность
  "timestamp": ...,      // момент формирования сообщения
  "status": "ok",        // warn, error
  "message": "my diagnostic message", // форматная строка
  // дополнительные поля при необходимости
}
```

> ID диагностик можно считать как хеш от пути диагностики внутри сервиса, при этом подмешивать в него ID конкретного инстанса сервиса \(на случай, если какие-то демоны будут запускаться в несколько инстансов\).

Сообщения для диагностик есть смысл делать с помощью форматной строки, которую заполнять дополнительными полями. В этом случае мы получаем сразу много полезных возможностей:

* автоматический сбор метрик с диагностик;
* локализация \(перевод\) сообщений о диагностиках;
* унифицированный вывод для разных демонов.

> Преимущество формата JSON по сравнению с отдельными сообщениями в том, что не будет возникать гонка из-за неодновременного обновления статуса и текста сообщения, что может привести к некрасивым эффектам в интерфейсе, когда сообщение "всё ок" вдруг выводится со статусом "ошибка".
>
> С другой стороны, если сервису агрегирования диагностик не нужно будет использовать текст сообщения, он может подписаться на сообщения по маске `/diags/#/status` и получить всё, что ему нужно без лишних данных.
>
> В общем, этот вопрос пока открыт и достоин обсуждения.

Далее демон системы диагностики собирает сообщения от всех сервисов и формирует агрегированные статусы для категорий. Например, при публикации сообщения в топик `/diags/serial/bus1/device1/pollrate`, демон системы диагностики должен обновить статус в топиках категорий:

* `/diags/serial/status`
* `/diags/serial/bus1/status`
* `/diags/serial/bus1/device1/status`

Также по мере поступления сообщений демон диагностики сохраняет их в логи. В качестве бэкенда для логов можно использовать `journald` \(или, в крайнем случае, собственную базу данных\).

Для выгрузки истории по отдельным диагностикам демон может реализовывать MQTT-RPC методы на манер `wb-history`.

### Пользовательский интерфейс

Диагностики будут появляться в пользовательском интерфейсе в следующих представлениях:

* **иконка в верхней панели** с пометкой о количестве проблемных диагностик \(похоже на иконку уведомлений на Github или любом другом сайте\);
* **список проблемных диагностик** \(высвечивается при нажатии на иконку в панели или на странице с диагностиками\);
* **дерево диагностик** \(на странице диагностик, служит для настройки фильтрации и просмотра статусов по подсистемам\). Пример такого интерфейса [здесь](http://files.webconn.ru/wb-diag-demo/demo/app/).

Дополнительно будут доступны **CLI-утилиты** для работы с диагностиками, чтобы можно было посмотреть статус через консоль.

### Примеры системных диагностик

* Занятое пространство на пользовательском разделе;
* Напряжение питания и статус батареи резервного питания;
* Наличие сетевого подключения \(вплоть до статуса пинга конкретного хоста\);
* Потребление памяти/CPU отдельными процессами \(может собираться отдельным демоном или на уровне библиотеки `libwbmqtt`/`wbgo`\);
* Предупреждение о включённом отладочном выводе в процессе;
* Статус жизненно важных процессов \(фронтенд для `systemctl status`\).

### Примеры диагностик на примере wb-mqtt-serial

* Частота опроса устройства \(насколько реальная соответствует ожидаемой\);
* Версия прошивки/бутлодера \(соответствие её доступной на контроллере\);
* Ошибки при опросе устройства \(собирать статистику в плавающем окне\);
* Ошибочные состояния устройства \(по регистрам\);
* Ошибочные состояния шины \(неожиданный второй мастер на шине, ...\) и т.д.

